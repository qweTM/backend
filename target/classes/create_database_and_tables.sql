-- ============================================\n-- 论坛系统 PostgreSQL 数据库初始化脚本\n-- 创建数据库和表结构\n-- ============================================\n\n-- 先在默认数据库中创建forum_db数据库\n-- 注意：这个脚本需要以有创建数据库权限的用户（如postgres）在默认数据库中执行\n\n-- 1. 创建数据库（如果不存在）\nDO $$\nBEGIN\n    IF NOT EXISTS (SELECT 1 FROM pg_database WHERE datname = 'forum_db') THEN\n        CREATE DATABASE forum_db;\n        RAISE NOTICE 'Database forum_db created successfully';\n    ELSE\n        RAISE NOTICE 'Database forum_db already exists';\n    END IF;\nEND$$;\n\n-- 切换到forum_db数据库并执行表结构创建\n-- 注意：以下语句需要在forum_db数据库上下文执行\n\n-- 使用此脚本的方式：\n-- 1. 首先以postgres用户在默认数据库（如postgres）中执行前半部分创建数据库\n-- 2. 然后在forum_db数据库中执行后半部分创建表结构\n\n-- 2. 以下是在forum_db数据库中执行的表结构创建脚本\n-- 请将这部分复制到新的会话中，连接到forum_db数据库后执行\n/*\n\n-- 扩展\nCREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";\n\n-- ============================================\n-- 1. 用户表 (Users)\n-- ============================================\nCREATE TABLE users (\n    id SERIAL PRIMARY KEY,\n    username VARCHAR(20) NOT NULL UNIQUE,\n    email VARCHAR(255) NOT NULL UNIQUE,\n    password_hash VARCHAR(255) NOT NULL,  -- 存储加密后的密码\n    avatar TEXT,  -- 头像URL\n    bio TEXT,  -- 个人简介\n    join_date TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,\n    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,\n    \n    -- 约束\n    CONSTRAINT username_format CHECK (username ~ '^[a-zA-Z0-9_]+$'),\n    CONSTRAINT username_length CHECK (char_length(username) >= 3 AND char_length(username) <= 20),\n    CONSTRAINT password_length CHECK (char_length(password_hash) >= 6)\n);\n\n-- 用户表索引\nCREATE INDEX idx_users_username ON users(username);\nCREATE INDEX idx_users_email ON users(email);\n\n-- ============================================\n-- 2. 分类表 (Categories)\n-- ============================================\nCREATE TABLE categories (\n    id SERIAL PRIMARY KEY,\n    name VARCHAR(100) NOT NULL UNIQUE,\n    description TEXT,\n    color VARCHAR(7),  -- 颜色代码，如 #3498db\n    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP\n);\n\n-- ============================================\n-- 3. 标签表 (Tags)\n-- ============================================\nCREATE TABLE tags (\n    id SERIAL PRIMARY KEY,\n    name VARCHAR(50) NOT NULL UNIQUE,\n    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP\n);\n\n-- 标签表索引\nCREATE INDEX idx_tags_name ON tags(name);\n\n-- ============================================\n-- 4. 帖子表 (Posts)\n-- ============================================\nCREATE TABLE posts (\n    id SERIAL PRIMARY KEY,\n    title VARCHAR(200) NOT NULL,\n    content TEXT NOT NULL,\n    excerpt TEXT,  -- 内容摘要\n    author_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n    category_id INTEGER NOT NULL REFERENCES categories(id) ON DELETE RESTRICT,\n    view_count INTEGER NOT NULL DEFAULT 0,\n    like_count INTEGER NOT NULL DEFAULT 0,\n    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,\n    \n    -- 约束\n    CONSTRAINT title_length CHECK (char_length(title) >= 5 AND char_length(title) <= 200),\n    CONSTRAINT content_length CHECK (char_length(content) >= 10)\n);\n\n-- 帖子表索引\nCREATE INDEX idx_posts_author_id ON posts(author_id);\nCREATE INDEX idx_posts_category_id ON posts(category_id);\nCREATE INDEX idx_posts_created_at ON posts(created_at DESC);\nCREATE INDEX idx_posts_view_count ON posts(view_count DESC);\nCREATE INDEX idx_posts_like_count ON posts(like_count DESC);\nCREATE INDEX idx_posts_title ON posts USING gin(to_tsvector('english', title));  -- 全文搜索\n\n-- ============================================\n-- 5. 帖子标签关联表 (Post Tags - 多对多关系)\n-- ============================================\nCREATE TABLE post_tags (\n    post_id INTEGER NOT NULL REFERENCES posts(id) ON DELETE CASCADE,\n    tag_id INTEGER NOT NULL REFERENCES tags(id) ON DELETE CASCADE,\n    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,\n    PRIMARY KEY (post_id, tag_id)\n);\n\n-- 帖子标签关联表索引\nCREATE INDEX idx_post_tags_post_id ON post_tags(post_id);\nCREATE INDEX idx_post_tags_tag_id ON post_tags(tag_id);\n\n-- ============================================\n-- 6. 评论表 (Comments)\n-- ============================================\nCREATE TABLE comments (\n    id SERIAL PRIMARY KEY,\n    content TEXT NOT NULL,\n    author_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n    post_id INTEGER NOT NULL REFERENCES posts(id) ON DELETE CASCADE,\n    parent_id INTEGER REFERENCES comments(id) ON DELETE CASCADE,  -- 父评论ID，用于回复\n    like_count INTEGER NOT NULL DEFAULT 0,\n    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,\n    \n    -- 约束\n    CONSTRAINT content_length CHECK (char_length(content) >= 1 AND char_length(content) <= 1000)\n);\n\n-- 评论表索引\nCREATE INDEX idx_comments_author_id ON comments(author_id);\nCREATE INDEX idx_comments_post_id ON comments(post_id);\nCREATE INDEX idx_comments_parent_id ON comments(parent_id);\nCREATE INDEX idx_comments_created_at ON comments(created_at DESC);\n\n-- ============================================\n-- 7. 触发器：自动更新 updated_at 字段\n-- ============================================\nCREATE OR REPLACE FUNCTION update_updated_at_column()\nRETURNS TRIGGER AS $$\nBEGIN\n    NEW.updated_at = CURRENT_TIMESTAMP;\n    RETURN NEW;\nEND;\n$$ language 'plpgsql';\n\n-- 为需要的表添加触发器\nCREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users\n    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n\nCREATE TRIGGER update_categories_updated_at BEFORE UPDATE ON categories\n    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n\nCREATE TRIGGER update_posts_updated_at BEFORE UPDATE ON posts\n    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n\nCREATE TRIGGER update_comments_updated_at BEFORE UPDATE ON comments\n    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n\n-- ============================================\n-- 8. 视图：用户统计信息（用于快速获取 postCount 和 commentCount）\n-- ============================================\nCREATE VIEW user_stats AS\nSELECT \n    u.id,\n    u.username,\n    COUNT(DISTINCT p.id) AS post_count,\n    COUNT(DISTINCT c.id) AS comment_count\nFROM users u\nLEFT JOIN posts p ON p.author_id = u.id\nLEFT JOIN comments c ON c.author_id = u.id\nGROUP BY u.id, u.username;\n\n-- ============================================\n-- 9. 视图：分类统计信息（用于快速获取 postCount）\n-- ============================================\nCREATE VIEW category_stats AS\nSELECT \n    cat.id,\n    cat.name,\n    cat.description,\n    cat.color,\n    COUNT(p.id) AS post_count\nFROM categories cat\nLEFT JOIN posts p ON p.category_id = cat.id\nGROUP BY cat.id, cat.name, cat.description, cat.color;\n\n-- ============================================\n-- 10. 视图：标签统计信息（用于快速获取 postCount）\n-- ============================================\nCREATE VIEW tag_stats AS\nSELECT \n    t.id,\n    t.name,\n    COUNT(pt.post_id) AS post_count\nFROM tags t\nLEFT JOIN post_tags pt ON pt.tag_id = t.id\nGROUP BY t.id, t.name;\n\n-- ============================================\n-- 11. 函数：获取帖子评论数量\n-- ============================================\nCREATE OR REPLACE FUNCTION get_post_comment_count(post_id_param INTEGER)\nRETURNS INTEGER AS $$\nBEGIN\n    RETURN (SELECT COUNT(*) FROM comments WHERE post_id = post_id_param);\nEND;\n$$ LANGUAGE plpgsql;\n\n-- ============================================\n-- 12. 初始化数据（可选）\n-- ============================================\n-- 插入示例分类\nINSERT INTO categories (name, description, color) VALUES\n    ('技术讨论', '编程技术相关讨论', '#3498db'),\n    ('问答求助', '技术问题求助', '#e74c3c'),\n    ('资源分享', '学习资源和技术分享', '#2ecc71'),\n    ('闲聊灌水', '日常闲聊', '#f39c12')\nON CONFLICT (name) DO NOTHING;\n\n-- ============================================\n-- 注释说明\n-- ============================================\nCOMMENT ON TABLE users IS '用户表，存储用户基本信息和认证信息';\nCOMMENT ON TABLE categories IS '分类表，存储论坛版块分类';\nCOMMENT ON TABLE tags IS '标签表，存储帖子标签';\nCOMMENT ON TABLE posts IS '帖子表，存储论坛帖子内容';\nCOMMENT ON TABLE post_tags IS '帖子标签关联表，多对多关系';\nCOMMENT ON TABLE comments IS '评论表，支持嵌套回复';\n\nCOMMENT ON COLUMN users.password_hash IS '加密后的密码，不存储明文';\nCOMMENT ON COLUMN comments.parent_id IS '父评论ID，NULL表示顶级评论，非NULL表示回复';\nCOMMENT ON COLUMN posts.excerpt IS '帖子内容摘要，可从content自动生成';\n\nRAISE NOTICE 'All tables, views and triggers created successfully in forum_db database';\n\n*/